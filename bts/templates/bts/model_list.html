{% comment %}
Bauteilsortiment - An Electronic Component Archival System
Copyright (C) 2023  nomike

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load static %}
{% load view_extras %}
<table id="list" class="maintable">
</table>
<div id="navigation"></div>
<script>
    var list_fields = {{ list_fields|safe }};
    var list_detail_link_fields = {{ list_detail_link_fields|safe }};
    var list_foreign_link_fields = {{ list_foreign_link_fields|safe|default:"[]" }};
    function readData(url) {
        fetch(url).then((response) => response.text())
            .then(function (r) {
                $('table#list').empty();
                response = $.parseJSON(r);
                tr = $('<tr>');
                list_fields.forEach(
                    function (value) {
                        tr.append($("<th>").text(value));
                    }
                )
                $("#navigation").empty();
                if (response.previous) {
                    $("#navigation").append($("<a>", {
                        href: "#",
                        text: "<",
                        title: "Previous page",
                        click: function () {
                            readData(response.previous);
                        }
                    }));
                }
                if (response.next) {
                    $("#navigation").append($("<a>", {
                        href: "#",
                        text: ">",
                        title: "Next page",
                        click: function () {
                            readData(response.next);
                        }
                    }));
                }
                $('table#list').append(tr);
                response.results.forEach(
                    function (row) {
                        tr = $("<tr>");
                        list_fields.forEach(function (value) {
                            if(list_detail_link_fields.includes(value)) {
                                tr.append($("<td>").append($("<a>", {text: row[value], href: "/bts/m/{{object_list.0|get_type}}/id/" + row['id']})));
                            } else if(list_foreign_link_fields.includes(value)) {
                                tr.append($("<td>").append($("<a>", {text: row[value], href: "/bts/m/{{object_list.0|get_type}}/id/" + row['id']})));
                            } else {
                                tr.append($("<td>").text(row[value]));
                            }
                        });
                        $('table#list').append(tr);
                    }
                )
            })
            .catch((error) => {
                console.warn(error);
            });
    }


    window.onload = function () {
        readData('http://localhost:8000/bts/api/v0/{{ object_list.0|get_meta|hash:"verbose_name_plural"|hash:"title"|cut:" " }}/?limit=10');
    } 
</script>
    {% comment %} <tr>
        {% for field in list_fields %}
        <th>{{ field|snake_to_space }}</th>
        {% endfor %}
    </tr>
    {% for object in object_list %}
    <tr>
        {% for field in list_fields %}
        {% with field_id=field|add:"_id" %}
        <td>
            {% if field in list_detail_link_fields %}
            <a href="{% url object_list.0|get_meta|hash:"object_name"|add:"_detail" object.id %}">
            {% endif %}
            {% if field in list_foreign_link_fields %}
            <a href="{% url object|hash:field|get_type|add:"_detail" object|hash:field_id %}">
            {% endif %}
            {{ object|hash:field }}
            {% if field in list_foreign_link_fields %}
            </a>
            {% endif %}
            {% if field in list_detail_link_fields %}
            </a>
            {% endif %}
        </td>
        {% endwith %}
        {% endfor %}
    </tr>
    {% endfor %}
</table> {% endcomment %}
